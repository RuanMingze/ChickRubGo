<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册 - ChickRubGo</title>
    <link rel="icon" type="image/png" href="./favicon-2.png">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .register-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            width: 400px;
            max-width: 90%;
        }
        
        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4f46e5;
        }
        
        .slogan {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background-color: #f9fafb;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            background-color: white;
        }
        
        .register-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px;
        }
        
        .register-btn:hover {
            background-color: #4338ca;
        }
        
        .login-link {
            color: #4f46e5;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .login-link:hover {
            color: #4338ca;
            text-decoration: underline;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 18px;
        }
        
        .success-message {
            color: #10b981;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 18px;
        }
        
        /* 深色模式样式 */
        body.dark-mode {
            background-color: #121212;
            color: #E5E7EB;
        }
        
        body.dark-mode .register-container {
            background-color: rgba(31, 41, 55, 0.92);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .logo {
            color: #6366F1;
        }
        
        body.dark-mode .slogan {
            color: #9CA3AF;
        }
        
        body.dark-mode .form-label {
            color: #E5E7EB;
        }
        
        body.dark-mode .form-input {
            background-color: #1f2937;
            border-color: #374151;
            color: #E5E7EB;
        }
        
        body.dark-mode .form-input:focus {
            border-color: #6366F1;
            background-color: #1f2937;
        }
        
        body.dark-mode .register-btn {
            background-color: #6366F1;
            color: #E5E7EB;
        }
        
        body.dark-mode .register-btn:hover {
            background-color: #4f46e5;
        }
        
        body.dark-mode .login-link {
            color: #6366F1;
        }
        
        body.dark-mode .login-link:hover {
            color: #818CF8;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="logo">ChickRubGo</div>
        <div class="slogan">创建账号</div>
        
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
        
        <div class="form-group">
            <label class="form-label" for="username">用户名</label>
            <input type="text" class="form-input" id="username" placeholder="请输入用户名" required>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="full_name">全名</label>
            <input type="text" class="form-input" id="full_name" placeholder="请输入全名（选填）">
        </div>
        
        <div class="form-group">
            <label class="form-label" for="email">邮箱</label>
            <input type="email" class="form-input" id="email" placeholder="请输入邮箱" required>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="password">密码</label>
            <input type="password" class="form-input" id="password" placeholder="请输入密码（至少6位）" minlength="6" required>
        </div>
        
        <button class="register-btn" id="register-btn">
            <i class="fa-solid fa-user-plus"></i>
            注册账号
        </button>
        
        <a href="./login.html" class="login-link">已有账号？前往登录</a>
    </div>

    <!-- 仅引入本地SDK，无CDN -->
    <script src="./Supabase-SDK.js"></script>
    <script>
        // 初始化本地Supabase客户端
        const supabaseUrl = 'https://pyywrxrmtehucmkpqkdi.supabase.co';
        const supabaseKey = 'sb_publishable_Ztie93n2pi48h_rAIuviyA_ftjAIDuj';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // DOM元素
        const registerBtn = document.getElementById('register-btn');
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        const usernameInput = document.getElementById('username');
        const fullNameInput = document.getElementById('full_name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        // 加载深色模式
        function loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true' || true;
            if (isDark) document.body.classList.add('dark-mode');
        }

        // 清空提示
        function clearMessages() {
            errorMsg.textContent = '';
            successMsg.textContent = '';
        }

        // 注册核心逻辑（无邮箱验证）
        async function handleRegister() {
            clearMessages();
            const username = usernameInput.value.trim();
            const fullName = fullNameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            // 基础验证
            if (!username || !email || !password) {
                errorMsg.textContent = '用户名、邮箱、密码为必填项';
                return;
            }
            if (password.length < 6) {
                errorMsg.textContent = '密码长度至少6位';
                return;
            }

            try {
                console.log('开始注册，邮箱:', email);
                // 1. Supabase Auth注册（启用邮箱验证）
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: 'https://pyywrxrmtehucmkpqkdi.supabase.co/auth/v1/callback'
                    }
                });

                console.log('注册响应:', { authData, authError });

                if (authError) throw authError;

                // 成功提示（包含邮箱验证提示）
                successMsg.textContent = '注册成功！请检查邮箱并点击验证链接，然后再登录';
                console.log('注册成功，用户ID:', authData?.user?.id);
                console.log('完整注册响应:', authData);
                console.log('注意：需要验证邮箱后才能登录');
                // 清空表单
                usernameInput.value = '';
                fullNameInput.value = '';
                emailInput.value = '';
                passwordInput.value = '';
                // 添加手动跳转链接
                const loginLink = document.querySelector('.login-link');
                if (loginLink) {
                    loginLink.textContent = '验证邮箱后点击这里登录';
                }

            } catch (err) {
                console.error('注册失败:', err);
                console.error('错误详情:', { message: err.message, code: err.code, details: err.details });
                // 友好错误提示
                if (err.message.includes('Email already registered')) {
                    errorMsg.textContent = '该邮箱已注册，请直接登录';
                } else if (err.message.includes('Invalid email')) {
                    errorMsg.textContent = '邮箱格式不正确';
                } else {
                    errorMsg.textContent = '注册失败：' + err.message;
                }
            }
        }

        // 绑定事件
        registerBtn.addEventListener('click', handleRegister);
        // 回车提交
        [usernameInput, fullNameInput, emailInput, passwordInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
        });

        // 页面加载初始化
        window.addEventListener('load', loadDarkMode);
    </script>
</body>
</html>